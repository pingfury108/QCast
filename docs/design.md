# QCast éŸ³è§†é¢‘æ‰˜ç®¡å¹³å°è®¾è®¡æ–‡æ¡£

## ä¸€ã€é¡¹ç›®æ¦‚è¿°

QCast æ˜¯ä¸€ä¸ªä¸ªäººéŸ³è§†é¢‘æ‰˜ç®¡å¹³å°ï¼Œç”¨æˆ·å¯ä»¥ä¸Šä¼ éŸ³é¢‘ã€è§†é¢‘æ–‡ä»¶ï¼Œä¸ºè¿™äº›æ–‡ä»¶ç”Ÿæˆå›ºå®šçš„è®¿é—®é“¾æ¥å’ŒäºŒç»´ç ï¼Œå¹¶é€šè¿‡ Book è¿›è¡Œåˆ†ç±»ç®¡ç†ã€‚

### æ ¸å¿ƒåŠŸèƒ½
1. **ç”¨æˆ·ç®¡ç†**ï¼šæ³¨å†Œã€ç™»å½•ã€è®¤è¯
2. **Book ç®¡ç†**ï¼šä¹¦ç±/ä¸“è¾‘/æ’­å®¢ç³»åˆ—ç­‰ï¼ˆæ”¯æŒå±‚çº§ç»“æ„ï¼‰
3. **åª’ä½“æ–‡ä»¶ç®¡ç†**ï¼šä¸Šä¼ éŸ³é¢‘/è§†é¢‘ï¼Œç”Ÿæˆå›ºå®šè®¿é—®é“¾æ¥
4. **äºŒç»´ç ç”Ÿæˆ**ï¼šä¸ºæ¯ä¸ªåª’ä½“æ–‡ä»¶ç”ŸæˆäºŒç»´ç 
5. **å±‚çº§ç»„ç»‡**ï¼šBook â†’ Chapter â†’ Media ç»“æ„

---

## äºŒã€æ•°æ®åº“æ¨¡å‹è®¾è®¡

### 2.1 Books è¡¨ï¼ˆä¹¦ç±/ä¸“è¾‘/ç³»åˆ—ï¼‰

```sql
CREATE TABLE books (
    id INTEGER PRIMARY KEY,
    user_id INTEGER NOT NULL,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    cover_image VARCHAR(512),
    parent_id INTEGER,              -- æ”¯æŒå¤šçº§åˆ†ç±»
    sort_order INTEGER DEFAULT 0,
    is_public BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (parent_id) REFERENCES books(id)
);
```

### 2.2 Chapters è¡¨ï¼ˆç« èŠ‚/é›†ï¼‰

```sql
CREATE TABLE chapters (
    id INTEGER PRIMARY KEY,
    book_id INTEGER NOT NULL,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    sort_order INTEGER DEFAULT 0,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    FOREIGN KEY (book_id) REFERENCES books(id) ON DELETE CASCADE
);
```

### 2.3 Media è¡¨ï¼ˆåª’ä½“æ–‡ä»¶ï¼‰

```sql
CREATE TABLE media (
    id INTEGER PRIMARY KEY,
    chapter_id INTEGER,              -- å¯é€‰ï¼Œå±äºæŸç« èŠ‚
    book_id INTEGER NOT NULL,        -- å¿…é¡»å±äºæŸä¸ª Book
    user_id INTEGER NOT NULL,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    file_type VARCHAR(10) NOT NULL,  -- 'audio' or 'video'
    file_path VARCHAR(512) NOT NULL, -- å­˜å‚¨è·¯å¾„
    file_size BIGINT,
    duration INTEGER,                -- æ—¶é•¿ï¼ˆç§’ï¼‰
    mime_type VARCHAR(100),
    access_token VARCHAR(64) UNIQUE NOT NULL, -- å…¬å¼€è®¿é—®å”¯ä¸€æ ‡è¯†
    access_url VARCHAR(512),         -- å®Œæ•´è®¿é—®é“¾æ¥
    qr_code_path VARCHAR(512),       -- äºŒç»´ç å›¾ç‰‡è·¯å¾„
    play_count INTEGER DEFAULT 0,    -- æ’­æ”¾æ¬¡æ•°
    is_public BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    FOREIGN KEY (book_id) REFERENCES books(id) ON DELETE CASCADE,
    FOREIGN KEY (chapter_id) REFERENCES chapters(id) ON DELETE SET NULL,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

### 2.4 å±‚çº§å…³ç³»

```
User
  â””â”€â”€ Book (å¯å¤šçº§åµŒå¥—ï¼Œé€šè¿‡ parent_id)
        â”œâ”€â”€ Chapter (å¯é€‰)
        â”‚     â””â”€â”€ Media
        â””â”€â”€ Media (ç›´æ¥å±äº Bookï¼Œä¸å±äº Chapter)
```

---

## ä¸‰ã€åç«¯ API è®¾è®¡

### 3.1 é¡¹ç›®ç»“æ„

```
src/
â”œâ”€â”€ controllers/
â”‚   â”œâ”€â”€ auth.rs           # ç”¨æˆ·è®¤è¯ï¼ˆå·²æœ‰ï¼‰
â”‚   â”œâ”€â”€ books.rs          # ä¹¦ç±ç®¡ç†
â”‚   â”œâ”€â”€ chapters.rs       # ç« èŠ‚ç®¡ç†
â”‚   â”œâ”€â”€ media.rs          # åª’ä½“æ–‡ä»¶ç®¡ç†
â”‚   â””â”€â”€ public.rs         # å…¬å¼€è®¿é—®
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ _entities/
â”‚   â”‚   â”œâ”€â”€ users.rs      # (å·²æœ‰)
â”‚   â”‚   â”œâ”€â”€ books.rs
â”‚   â”‚   â”œâ”€â”€ chapters.rs
â”‚   â”‚   â””â”€â”€ media.rs
â”‚   â”œâ”€â”€ books.rs          # Book ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ chapters.rs       # Chapter ä¸šåŠ¡é€»è¾‘
â”‚   â””â”€â”€ media.rs          # Media ä¸šåŠ¡é€»è¾‘
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ storage.rs        # æ–‡ä»¶å­˜å‚¨æœåŠ¡
â”‚   â”œâ”€â”€ qrcode.rs         # äºŒç»´ç ç”Ÿæˆ
â”‚   â””â”€â”€ media_processor.rs # åª’ä½“å¤„ç†ï¼ˆæå–æ—¶é•¿ã€ç¼©ç•¥å›¾ç­‰ï¼‰
â”œâ”€â”€ workers/
â”‚   â””â”€â”€ media_processor.rs # åå°å¤„ç†åª’ä½“æ–‡ä»¶
â””â”€â”€ views/
    â”œâ”€â”€ books.rs          # Book å“åº”è§†å›¾
    â”œâ”€â”€ chapters.rs       # Chapter å“åº”è§†å›¾
    â””â”€â”€ media.rs          # Media å“åº”è§†å›¾
```

### 3.2 API è·¯ç”±è®¾è®¡

#### Books APIï¼ˆéœ€è¦è®¤è¯ï¼‰

```
POST   /api/books                     åˆ›å»ºä¹¦ç±
GET    /api/books                     è·å–æˆ‘çš„ä¹¦ç±åˆ—è¡¨ï¼ˆæ”¯æŒæ ‘å½¢ç»“æ„ï¼‰
GET    /api/books/:id                 è·å–ä¹¦ç±è¯¦æƒ…
PUT    /api/books/:id                 æ›´æ–°ä¹¦ç±
DELETE /api/books/:id                 åˆ é™¤ä¹¦ç±
GET    /api/books/:id/tree            è·å–ä¹¦ç±å®Œæ•´æ ‘å½¢ç»“æ„ï¼ˆå«ç« èŠ‚å’Œåª’ä½“ï¼‰
POST   /api/books/:id/reorder         è°ƒæ•´ä¹¦ç±é¡ºåº
```

**è¯·æ±‚/å“åº”ç¤ºä¾‹ï¼š**

```json
// POST /api/books
{
  "title": "æˆ‘çš„æ’­å®¢ç³»åˆ—",
  "description": "è¿™æ˜¯æˆ‘çš„ç¬¬ä¸€ä¸ªæ’­å®¢",
  "parent_id": null,
  "is_public": true
}

// Response
{
  "id": 1,
  "user_id": 1,
  "title": "æˆ‘çš„æ’­å®¢ç³»åˆ—",
  "description": "è¿™æ˜¯æˆ‘çš„ç¬¬ä¸€ä¸ªæ’­å®¢",
  "cover_image": null,
  "parent_id": null,
  "is_public": true,
  "created_at": "2025-10-06T12:00:00Z"
}
```

#### Chapters APIï¼ˆéœ€è¦è®¤è¯ï¼‰

```
POST   /api/books/:book_id/chapters   åˆ›å»ºç« èŠ‚
GET    /api/books/:book_id/chapters   è·å–ç« èŠ‚åˆ—è¡¨
GET    /api/chapters/:id              è·å–ç« èŠ‚è¯¦æƒ…
PUT    /api/chapters/:id              æ›´æ–°ç« èŠ‚
DELETE /api/chapters/:id              åˆ é™¤ç« èŠ‚
POST   /api/chapters/:id/reorder      è°ƒæ•´ç« èŠ‚é¡ºåº
```

#### Media APIï¼ˆéœ€è¦è®¤è¯ï¼‰

```
POST   /api/media/upload              ä¸Šä¼ åª’ä½“æ–‡ä»¶ï¼ˆmultipart/form-dataï¼‰
GET    /api/media                     è·å–æˆ‘çš„åª’ä½“åˆ—è¡¨
GET    /api/media/:id                 è·å–åª’ä½“è¯¦æƒ…
PUT    /api/media/:id                 æ›´æ–°åª’ä½“ä¿¡æ¯
DELETE /api/media/:id                 åˆ é™¤åª’ä½“
GET    /api/media/:id/qrcode          è·å–äºŒç»´ç å›¾ç‰‡
POST   /api/media/:id/regenerate-qr   é‡æ–°ç”ŸæˆäºŒç»´ç 
POST   /api/media/:id/publish         å‘å¸ƒ/å–æ¶ˆå‘å¸ƒ
```

**ä¸Šä¼ è¯·æ±‚ç¤ºä¾‹ï¼š**

```
POST /api/media/upload
Content-Type: multipart/form-data

file: [binary data]
title: "ç¬¬ä¸€é›†"
description: "è¿™æ˜¯ç¬¬ä¸€é›†çš„å†…å®¹"
book_id: 1
chapter_id: 1  (å¯é€‰)
```

**å“åº”ç¤ºä¾‹ï¼š**

```json
{
  "id": 1,
  "title": "ç¬¬ä¸€é›†",
  "description": "è¿™æ˜¯ç¬¬ä¸€é›†çš„å†…å®¹",
  "file_type": "audio",
  "file_size": 10485760,
  "duration": 1200,
  "access_token": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "access_url": "http://localhost:5150/public/media/a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "qr_code_path": "/static/qrcodes/1.png",
  "is_public": false,
  "created_at": "2025-10-06T12:00:00Z"
}
```

#### Public APIï¼ˆæ— éœ€è®¤è¯ï¼‰

```
GET    /public/media/:access_token    æ’­æ”¾åª’ä½“ï¼ˆæ”¯æŒ Range è¯·æ±‚ï¼‰
GET    /public/media/:access_token/info  è·å–åª’ä½“ä¿¡æ¯
GET    /public/books/:id              æŸ¥çœ‹å…¬å¼€ä¹¦ç±
```

---

## å››ã€æŠ€æœ¯é€‰å‹

### 4.1 åç«¯æŠ€æœ¯æ ˆ

| åŠŸèƒ½ | æŠ€æœ¯æ–¹æ¡ˆ | Rust Crate | è¯´æ˜ |
|------|---------|-----------|------|
| æ¡†æ¶ | Loco | `loco-rs = "0.16"` | å·²æœ‰ |
| æ–‡ä»¶ä¸Šä¼  | Multipart form | `axum-extra` | å·²æœ‰ |
| æ–‡ä»¶å­˜å‚¨ | æœ¬åœ°å­˜å‚¨ | `tokio::fs` | åˆæœŸä½¿ç”¨ |
| äºŒç»´ç ç”Ÿæˆ | QR Code | `qrcode` | å¾…æ·»åŠ  |
| å›¾ç‰‡å¤„ç† | Image | `image` | å¾…æ·»åŠ  |
| åª’ä½“ä¿¡æ¯æå– | FFmpeg | `ffmpeg-next` | å¯é€‰ |
| æµåª’ä½“ä¼ è¾“ | Range è¯·æ±‚ | `tower-http` | å¾…æ·»åŠ  |
| UUID ç”Ÿæˆ | UUID v4 | `uuid` | å·²æœ‰ |

**Cargo.toml éœ€è¦æ·»åŠ çš„ä¾èµ–ï¼š**

```toml
qrcode = "0.14"
image = "0.25"
tower-http = { version = "0.6", features = ["fs", "trace"] }
bytes = "1.5"
```

### 4.2 å‰ç«¯æŠ€æœ¯æ ˆ

```
ui/
â”œâ”€â”€ React 18 + TypeScript
â”œâ”€â”€ æ„å»ºå·¥å…·: Vite
â”œâ”€â”€ åŒ…ç®¡ç†: pnpm
â”œâ”€â”€ çŠ¶æ€ç®¡ç†: TanStack Query (React Query)
â”œâ”€â”€ UI æ¡†æ¶: Ant Design æˆ– shadcn/ui
â”œâ”€â”€ è·¯ç”±: React Router v6
â”œâ”€â”€ æ–‡ä»¶ä¸Šä¼ : react-dropzone
â”œâ”€â”€ æ’­æ”¾å™¨:
â”‚   â”œâ”€â”€ éŸ³é¢‘: Plyr
â”‚   â””â”€â”€ è§†é¢‘: video.js
â”œâ”€â”€ äºŒç»´ç å±•ç¤º: qrcode.react
â””â”€â”€ HTTP å®¢æˆ·ç«¯: axios
```

---

## äº”ã€å‰ç«¯é¡µé¢è®¾è®¡

### 5.1 é¡µé¢ç»“æ„

```
/                       é¦–é¡µï¼ˆå…¬å¼€ä¹¦ç±å±•ç¤ºï¼‰
/login                  ç™»å½•é¡µ
/register               æ³¨å†Œé¡µ

/dashboard              ç”¨æˆ·æ§åˆ¶å°ï¼ˆéœ€è¦è®¤è¯ï¼‰
  â”œâ”€â”€ /books            ä¹¦ç±ç®¡ç†ï¼ˆæ ‘å½¢åˆ—è¡¨ï¼‰
  â”œâ”€â”€ /books/new        åˆ›å»ºæ–°ä¹¦ç±
  â”œâ”€â”€ /books/:id        ä¹¦ç±è¯¦æƒ…ï¼ˆç¼–è¾‘ã€ç« èŠ‚ã€åª’ä½“ï¼‰
  â”œâ”€â”€ /books/:id/edit   ç¼–è¾‘ä¹¦ç±
  â”œâ”€â”€ /upload           æ‰¹é‡ä¸Šä¼ åª’ä½“
  â””â”€â”€ /media            æ‰€æœ‰åª’ä½“æ–‡ä»¶ç®¡ç†

/public/:token          å…¬å¼€è®¿é—®é¡µé¢ï¼ˆæ— éœ€è®¤è¯ï¼‰
  â”œâ”€â”€ åª’ä½“æ’­æ”¾å™¨
  â”œâ”€â”€ äºŒç»´ç å±•ç¤º
  â””â”€â”€ åˆ†äº«æŒ‰é’®
```

### 5.2 æ ¸å¿ƒé¡µé¢è®¾è®¡

#### ä¹¦ç±ç®¡ç†é¡µé¢ï¼ˆ/dashboard/booksï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æˆ‘çš„ä¹¦ç±                          [+ æ–°å»ºä¹¦ç±] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ” æœç´¢...                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“š Podcast ç³»åˆ— 1              [ç¼–è¾‘] [åˆ é™¤]  â”‚
â”‚    â”œâ”€â”€ ğŸ“– Season 1                             â”‚
â”‚    â”‚   â”œâ”€â”€ ğŸµ Episode 1  [ğŸ‘ï¸ å…¬å¼€] [QR]       â”‚
â”‚    â”‚   â””â”€â”€ ğŸµ Episode 2  [ğŸ”’ ç§å¯†] [QR]       â”‚
â”‚    â””â”€â”€ ğŸ“– Season 2                             â”‚
â”‚        â””â”€â”€ ğŸµ Episode 3  [ğŸ‘ï¸ å…¬å¼€] [QR]       â”‚
â”‚                                                 â”‚
â”‚  ğŸ“š æœ‰å£°ä¹¦                      [ç¼–è¾‘] [åˆ é™¤]  â”‚
â”‚    â”œâ”€â”€ ğŸµ ç¬¬ä¸€ç«             [ğŸ‘ï¸ å…¬å¼€] [QR]     â”‚
â”‚    â””â”€â”€ ğŸµ ç¬¬äºŒç«             [ğŸ”’ ç§å¯†] [QR]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ä¸Šä¼ é¡µé¢ï¼ˆ/dashboard/uploadï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸Šä¼ åª’ä½“æ–‡ä»¶                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é€‰æ‹©å½’å±ä¹¦ç±: [ä¸‹æ‹‰é€‰æ‹©]                     â”‚
â”‚  é€‰æ‹©å½’å±ç« èŠ‚: [ä¸‹æ‹‰é€‰æ‹©] (å¯é€‰)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„                         â”‚ â”‚
â”‚  â”‚   æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶                         â”‚ â”‚
â”‚  â”‚   æ”¯æŒ MP3, MP4, WAV, M4A ç­‰æ ¼å¼        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä¸Šä¼ é˜Ÿåˆ—:                                     â”‚
â”‚  âœ“ episode1.mp3  (100%)                       â”‚
â”‚  â³ episode2.mp3  (45%)                        â”‚
â”‚  â¸ï¸ episode3.mp4  (ç­‰å¾…ä¸­)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å…¬å¼€è®¿é—®é¡µé¢ï¼ˆ/public/:tokenï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚     [å°é¢å›¾/ç¼©ç•¥å›¾]      â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                     â”‚
â”‚   æ ‡é¢˜: ç¬¬ä¸€é›†                      â”‚
â”‚   æè¿°: è¿™æ˜¯ç¬¬ä¸€é›†çš„å†…å®¹            â”‚
â”‚   æ—¶é•¿: 20:00                       â”‚
â”‚   æ’­æ”¾æ¬¡æ•°: 123                     â”‚
â”‚                                     â”‚
â”‚   â”â”â”â”â”â”â”â”â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 12:34/20:00 â”‚
â”‚   [â®ï¸] [â¯ï¸] [â­ï¸]  [ğŸ”Š] [âš™ï¸] [å…¨å±] â”‚
â”‚                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚   â”‚              â”‚                 â”‚
â”‚   â”‚   QR Code    â”‚                 â”‚
â”‚   â”‚              â”‚                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                     â”‚
â”‚   [ğŸ“‹ å¤åˆ¶é“¾æ¥] [ğŸ“± åˆ†äº«] [â¬‡ï¸ ä¸‹è½½] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…­ã€æ–‡ä»¶å­˜å‚¨è®¾è®¡

### 6.1 ç›®å½•ç»“æ„

```
uploads/
  â”œâ”€â”€ users/
  â”‚   â””â”€â”€ {user_id}/
  â”‚       â””â”€â”€ books/
  â”‚           â””â”€â”€ {book_id}/
  â”‚               â”œâ”€â”€ media/
  â”‚               â”‚   â”œâ”€â”€ {uuid}.mp3
  â”‚               â”‚   â”œâ”€â”€ {uuid}.mp4
  â”‚               â”‚   â””â”€â”€ ...
  â”‚               â””â”€â”€ covers/
  â”‚                   â””â”€â”€ {uuid}.jpg
  â””â”€â”€ qrcodes/
      â”œâ”€â”€ {media_id}.png
      â””â”€â”€ ...

assets/
  â””â”€â”€ static/
      â”œâ”€â”€ qrcodes/          # äºŒç»´ç é™æ€è®¿é—®è·¯å¾„
      â””â”€â”€ uploads/          # è½¯é“¾æ¥åˆ° uploads/ (å¯é€‰)
```

### 6.2 è®¿é—®ç­–ç•¥

- **åª’ä½“æ–‡ä»¶**: é€šè¿‡ `/public/media/:access_token` è®¿é—®ï¼Œåç«¯æ ¡éªŒæƒé™
- **äºŒç»´ç **: é€šè¿‡ `/static/qrcodes/:id.png` ç›´æ¥è®¿é—®ï¼ˆé™æ€æ–‡ä»¶ï¼‰
- **å°é¢å›¾**: é€šè¿‡ `/static/covers/:filename` è®¿é—®

### 6.3 æ–‡ä»¶å‘½åè§„åˆ™

```rust
// åª’ä½“æ–‡ä»¶
let file_name = format!("{}.{}", Uuid::new_v4(), extension);

// äºŒç»´ç 
let qr_name = format!("{}.png", media_id);

// è®¿é—® token
let access_token = Uuid::new_v4().to_string();
```

---

## ä¸ƒã€æ ¸å¿ƒåŠŸèƒ½å®ç°ç»†èŠ‚

### 7.1 æ–‡ä»¶ä¸Šä¼ æµç¨‹

```
1. å‰ç«¯é€‰æ‹©æ–‡ä»¶ â†’ éªŒè¯æ ¼å¼å’Œå¤§å°
2. ä¸Šä¼ åˆ° /api/media/upload (multipart/form-data)
3. åç«¯æ¥æ”¶æ–‡ä»¶
   â”œâ”€â”€ ä¿å­˜åˆ°ä¸´æ—¶ç›®å½•
   â”œâ”€â”€ éªŒè¯æ–‡ä»¶ç±»å‹ï¼ˆMIME typeï¼‰
   â”œâ”€â”€ ç”Ÿæˆ UUID æ–‡ä»¶å
   â”œâ”€â”€ ç§»åŠ¨åˆ°ç›®æ ‡ç›®å½• uploads/users/{user_id}/books/{book_id}/media/
   â”œâ”€â”€ æå–åª’ä½“ä¿¡æ¯ï¼ˆæ—¶é•¿ã€ç ç‡ç­‰ï¼‰- å¯é€‰
   â”œâ”€â”€ ç”Ÿæˆè®¿é—® token
   â”œâ”€â”€ ç”Ÿæˆè®¿é—® URL
   â””â”€â”€ ä¿å­˜åˆ°æ•°æ®åº“
4. åå°ä»»åŠ¡ï¼ˆWorkerï¼‰
   â”œâ”€â”€ ç”ŸæˆäºŒç»´ç 
   â”œâ”€â”€ ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆè§†é¢‘ï¼‰
   â””â”€â”€ æ›´æ–°æ•°æ®åº“
5. è¿”å›å“åº”ç»™å‰ç«¯
```

### 7.2 äºŒç»´ç ç”Ÿæˆ

```rust
use qrcode::{QrCode, render::svg};
use image::Luma;

// ç”ŸæˆäºŒç»´ç 
let code = QrCode::new(access_url)?;
let image = code.render::<Luma<u8>>().build();
image.save(qr_code_path)?;
```

### 7.3 æµåª’ä½“ä¼ è¾“ï¼ˆæ”¯æŒ Range è¯·æ±‚ï¼‰

```rust
// ä½¿ç”¨ tower-http æä¾›æ–‡ä»¶æœåŠ¡
use tower_http::services::ServeFile;

// æ”¯æŒ Range è¯·æ±‚ï¼Œå®ç°æ–­ç‚¹ç»­ä¼ å’Œæ‹–åŠ¨æ’­æ”¾
// å“åº”å¤´: Accept-Ranges: bytes
// è¯·æ±‚å¤´: Range: bytes=0-1023
```

### 7.4 æƒé™æ§åˆ¶

```rust
// è®¿é—®æ§åˆ¶é€»è¾‘
pub async fn can_access_media(
    db: &DatabaseConnection,
    media_id: i32,
    user_id: Option<i32>,
) -> Result<bool> {
    let media = Media::find_by_id(db, media_id).await?;

    // å…¬å¼€æ–‡ä»¶ä»»ä½•äººéƒ½å¯ä»¥è®¿é—®
    if media.is_public {
        return Ok(true);
    }

    // ç§æœ‰æ–‡ä»¶åªæœ‰æ‰€æœ‰è€…å¯ä»¥è®¿é—®
    if let Some(uid) = user_id {
        return Ok(media.user_id == uid);
    }

    Ok(false)
}
```

---

## å…«ã€å®æ–½æ–¹æ¡ˆ

### æ–¹æ¡ˆ Aï¼šç®€åŒ–ç‰ˆ MVPï¼ˆæ¨èå…ˆå®ç°ï¼‰

**æ•°æ®æ¨¡å‹ï¼š**
```
User â†’ Book â†’ Media
```

**ç‰¹ç‚¹ï¼š**
- ä¸å®ç° Chapter å±‚çº§
- Book æ”¯æŒ `parent_id`ï¼ˆé¢„ç•™åµŒå¥—èƒ½åŠ›ï¼‰
- å¿«é€ŸéªŒè¯æ ¸å¿ƒåŠŸèƒ½

**å¼€å‘é¡ºåºï¼š**
1. âœ… ç”¨æˆ·è®¤è¯ï¼ˆå·²å®Œæˆï¼‰
2. æ•°æ®åº“ Migrationï¼ˆbooks, media è¡¨ï¼‰
3. Book CRUD API
4. Media ä¸Šä¼ åŠŸèƒ½
5. äºŒç»´ç ç”ŸæˆæœåŠ¡
6. å…¬å¼€è®¿é—® API
7. æµåª’ä½“æ’­æ”¾
8. å‰ç«¯ UI å¼€å‘

### æ–¹æ¡ˆ Bï¼šå®Œæ•´ç‰ˆ

**æ•°æ®æ¨¡å‹ï¼š**
```
User â†’ Book (å¯åµŒå¥—) â†’ Chapter â†’ Media
```

**ç‰¹ç‚¹ï¼š**
- æ”¯æŒå¤šçº§ Book åˆ†ç±»
- æ”¯æŒ Chapter ç®¡ç†
- æ›´çµæ´»çš„å†…å®¹ç»„ç»‡

**å®æ–½å»ºè®®ï¼š**
- åœ¨æ–¹æ¡ˆ A åŸºç¡€ä¸Šå¢åŠ  Chapter ç›¸å…³åŠŸèƒ½
- é€‚åˆå†…å®¹è¾ƒå¤šã€éœ€è¦ç²¾ç»†ç®¡ç†çš„åœºæ™¯

---

## ä¹ã€æŠ€æœ¯éš¾ç‚¹å’Œè§£å†³æ–¹æ¡ˆ

### 9.1 å¤§æ–‡ä»¶ä¸Šä¼ 

**é—®é¢˜ï¼š** ä¸Šä¼ å¤§å‹è§†é¢‘æ–‡ä»¶å¯èƒ½è¶…æ—¶æˆ–å ç”¨å¤§é‡å†…å­˜

**è§£å†³æ–¹æ¡ˆï¼š**
- ä½¿ç”¨æµå¼ä¸Šä¼ ï¼ˆstreamingï¼‰
- é™åˆ¶æ–‡ä»¶å¤§å°ï¼ˆå¦‚ 500MBï¼‰
- å¯é€‰ï¼šå®ç°åˆ†ç‰‡ä¸Šä¼ ï¼ˆchunked uploadï¼‰

### 9.2 åª’ä½“ä¿¡æ¯æå–

**é—®é¢˜ï¼š** éœ€è¦æå–éŸ³è§†é¢‘æ—¶é•¿ã€ç ç‡ç­‰ä¿¡æ¯

**è§£å†³æ–¹æ¡ˆï¼š**
- æ–¹æ¡ˆ 1ï¼šä½¿ç”¨ `ffmpeg-next` crateï¼ˆéœ€è¦ç³»ç»Ÿå®‰è£… FFmpegï¼‰
- æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ `symphonia` crateï¼ˆçº¯ Rustï¼Œä»…æ”¯æŒéŸ³é¢‘ï¼‰
- æ–¹æ¡ˆ 3ï¼šå‰ç«¯æå–ï¼ˆä½¿ç”¨ HTML5 APIï¼‰

### 9.3 æµåª’ä½“æ€§èƒ½

**é—®é¢˜ï¼š** å¤§é‡å¹¶å‘æ’­æ”¾å¯èƒ½å½±å“æ€§èƒ½

**è§£å†³æ–¹æ¡ˆï¼š**
- ä½¿ç”¨ CDNï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- æœ¬åœ°å¼€å‘ä½¿ç”¨ tower-http çš„é™æ€æ–‡ä»¶æœåŠ¡
- å®ç°ç¼“å­˜ç­–ç•¥

---

## åã€æœªæ¥æ‰©å±•

1. **ç»Ÿè®¡åˆ†æ**
   - æ’­æ”¾æ¬¡æ•°ã€æ—¶é•¿ç»Ÿè®¡
   - ç”¨æˆ·è¡Œä¸ºåˆ†æ

2. **é«˜çº§åŠŸèƒ½**
   - è¯„è®ºç³»ç»Ÿ
   - ç‚¹èµ/æ”¶è—
   - æ’­æ”¾åˆ—è¡¨
   - RSS è®¢é˜…

3. **å­˜å‚¨ä¼˜åŒ–**
   - å¯¹æ¥äº‘å­˜å‚¨ï¼ˆS3, OSSï¼‰
   - è‡ªåŠ¨è½¬ç ï¼ˆç»Ÿä¸€æ ¼å¼ï¼‰
   - è‡ªåŠ¨å‹ç¼©

4. **ç¤¾äº¤åŠŸèƒ½**
   - å…¬å¼€ä¸»é¡µ
   - å…³æ³¨/è®¢é˜…
   - åˆ†äº«åˆ°ç¤¾äº¤åª’ä½“

---

## åä¸€ã€å¼€å‘é‡Œç¨‹ç¢‘

### Phase 1: åç«¯åŸºç¡€ï¼ˆ1-2 å‘¨ï¼‰
- [ ] æ•°æ®åº“ Migration
- [ ] Book Model + API
- [ ] Media Model + API
- [ ] æ–‡ä»¶ä¸Šä¼ æœåŠ¡
- [ ] äºŒç»´ç ç”ŸæˆæœåŠ¡

### Phase 2: æ ¸å¿ƒåŠŸèƒ½ï¼ˆ1-2 å‘¨ï¼‰
- [ ] å…¬å¼€è®¿é—® API
- [ ] æµåª’ä½“æ’­æ”¾
- [ ] æƒé™æ§åˆ¶
- [ ] Worker åå°ä»»åŠ¡

### Phase 3: å‰ç«¯å¼€å‘ï¼ˆ2-3 å‘¨ï¼‰
- [ ] é¡¹ç›®åˆå§‹åŒ–ï¼ˆVite + Reactï¼‰
- [ ] è·¯ç”±å’Œå¸ƒå±€
- [ ] ä¹¦ç±ç®¡ç†é¡µé¢
- [ ] ä¸Šä¼ é¡µé¢
- [ ] æ’­æ”¾é¡µé¢

### Phase 4: ä¼˜åŒ–å’Œæµ‹è¯•ï¼ˆ1 å‘¨ï¼‰
- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] é”™è¯¯å¤„ç†
- [ ] å•å…ƒæµ‹è¯•
- [ ] é›†æˆæµ‹è¯•

---

## åäºŒã€é…ç½®æ–‡ä»¶è°ƒæ•´

### config/development.yaml

```yaml
server:
  middlewares:
    static:
      enable: true
      must_exist: false
      folder:
        uri: "/"
        path: "assets/static"
      fallback: "assets/static/index.html"
    # æ·»åŠ æ–‡ä»¶ä¸Šä¼ é™åˆ¶
    limit_payload:
      enable: true
      body_limit: 524288000  # 500MB

# åº”ç”¨é…ç½®
settings:
  upload:
    max_file_size: 524288000  # 500MB
    allowed_types: ["audio/mpeg", "audio/mp4", "video/mp4", "video/quicktime"]
    storage_path: "uploads"
  media:
    base_url: "http://localhost:5150"
```

---

## é™„å½•

### A. æ•°æ®åº“ç´¢å¼•å»ºè®®

```sql
-- Books
CREATE INDEX idx_books_user_id ON books(user_id);
CREATE INDEX idx_books_parent_id ON books(parent_id);

-- Chapters
CREATE INDEX idx_chapters_book_id ON chapters(book_id);

-- Media
CREATE INDEX idx_media_book_id ON media(book_id);
CREATE INDEX idx_media_chapter_id ON media(chapter_id);
CREATE INDEX idx_media_user_id ON media(user_id);
CREATE UNIQUE INDEX idx_media_access_token ON media(access_token);
CREATE INDEX idx_media_is_public ON media(is_public);
```

### B. API å“åº”æ ¼å¼è§„èŒƒ

```json
// æˆåŠŸå“åº”
{
  "data": { ... },
  "message": "æ“ä½œæˆåŠŸ"
}

// é”™è¯¯å“åº”
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "å‚æ•°éªŒè¯å¤±è´¥",
    "details": [
      {
        "field": "title",
        "message": "æ ‡é¢˜ä¸èƒ½ä¸ºç©º"
      }
    ]
  }
}

// åˆ†é¡µå“åº”
{
  "data": [...],
  "pagination": {
    "page": 1,
    "per_page": 20,
    "total": 100,
    "total_pages": 5
  }
}
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2025-10-06
**æœ€åæ›´æ–°**: 2025-10-06
**ä½œè€…**: Claude & pingfury
